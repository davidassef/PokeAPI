<!DOCTYPE html>
<html>
<head>
    <title>Diagn√≥stico de Conectividade</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .warning { background-color: #fff3cd; }
        button { padding: 10px 15px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico de Conectividade</h1>
    
    <button onclick="testBackendHealth()">Testar Backend Health</button>
    <button onclick="testBackendRanking()">Testar Backend Ranking</button>
    <button onclick="testCORS()">Testar CORS</button>
    <button onclick="testNetworkLatency()">Testar Lat√™ncia</button>
    <button onclick="runFullDiagnosis()">üöÄ Diagn√≥stico Completo</button>

    <div id="results"></div>

    <script>
        const BACKEND_URL = 'https://pokeapi-la6k.onrender.com';
        
        function addResult(title, content, type = 'success') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}`;
            document.getElementById('results').appendChild(div);
            console.log(`[${type.toUpperCase()}] ${title}: ${content}`);
        }

        async function testBackendHealth() {
            try {
                const startTime = Date.now();
                
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ Backend Health Check', 
                        `Status: ${response.status}<br>Tempo: ${duration}ms<br>Resposta: <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'success');
                } else {
                    addResult('‚ùå Backend Health Check', 
                        `Status: ${response.status}<br>Tempo: ${duration}ms<br>Erro: <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'error');
                }
            } catch (error) {
                addResult('‚ùå Backend Health Check', 
                    `Erro de rede: ${error.message}<br>Stack: <pre>${error.stack}</pre>`, 
                    'error');
            }
        }

        async function testBackendRanking() {
            try {
                const startTime = Date.now();
                
                const response = await fetch(`${BACKEND_URL}/api/v1/ranking/`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ Backend Ranking', 
                        `Status: ${response.status}<br>Tempo: ${duration}ms<br>Itens: ${data.length}<br>Amostra: <pre>${JSON.stringify(data.slice(0, 2), null, 2)}</pre>`, 
                        'success');
                } else {
                    addResult('‚ùå Backend Ranking', 
                        `Status: ${response.status}<br>Tempo: ${duration}ms<br>Erro: <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'error');
                }
            } catch (error) {
                addResult('‚ùå Backend Ranking', 
                    `Erro de rede: ${error.message}<br>Stack: <pre>${error.stack}</pre>`, 
                    'error');
            }
        }

        async function testCORS() {
            try {
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
                };
                
                addResult('‚úÖ CORS Test', 
                    `Status: ${response.status}<br>Headers CORS: <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>`, 
                    'success');
            } catch (error) {
                addResult('‚ùå CORS Test', 
                    `Erro: ${error.message}`, 
                    'error');
            }
        }

        async function testNetworkLatency() {
            const tests = [];
            
            for (let i = 0; i < 3; i++) {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${BACKEND_URL}/health`);
                    const endTime = Date.now();
                    tests.push(endTime - startTime);
                } catch (error) {
                    tests.push('ERROR');
                }
            }
            
            const validTests = tests.filter(t => typeof t === 'number');
            const avgLatency = validTests.length > 0 ? 
                Math.round(validTests.reduce((a, b) => a + b, 0) / validTests.length) : 
                'N/A';
            
            addResult('üåê Lat√™ncia de Rede', 
                `Testes: ${tests.join('ms, ')}<br>M√©dia: ${avgLatency}ms<br>Sucessos: ${validTests.length}/3`, 
                validTests.length >= 2 ? 'success' : 'warning');
        }

        async function runFullDiagnosis() {
            document.getElementById('results').innerHTML = '<h2>üöÄ Executando Diagn√≥stico Completo...</h2>';
            
            await testNetworkLatency();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCORS();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testBackendHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testBackendRanking();
            
            addResult('üéØ Diagn√≥stico Conclu√≠do', 
                'Verifique os resultados acima para identificar problemas de conectividade.', 
                'warning');
        }

        // Testar automaticamente quando a p√°gina carrega
        window.onload = function() {
            addResult('üì± P√°gina Carregada', 
                `Origin: ${window.location.origin}<br>User Agent: ${navigator.userAgent.substring(0, 100)}...`, 
                'success');
        };
    </script>
</body>
</html>
